<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>写后台总结 | Blesstosam&#39;s blog</title>
    <meta name="description" content="Blesstosam&#39;s blog">
    <link rel="icon" href="/github-blog/favicon.ico">
    
    <link rel="preload" href="/github-blog/assets/css/0.styles.78aca58c.css" as="style"><link rel="preload" href="/github-blog/assets/js/app.e3b10756.js" as="script"><link rel="preload" href="/github-blog/assets/js/2.1ab0c05b.js" as="script"><link rel="preload" href="/github-blog/assets/js/21.7e3b8cf1.js" as="script"><link rel="prefetch" href="/github-blog/assets/js/10.74514121.js"><link rel="prefetch" href="/github-blog/assets/js/11.65bfad95.js"><link rel="prefetch" href="/github-blog/assets/js/12.c45d2580.js"><link rel="prefetch" href="/github-blog/assets/js/13.da1d7953.js"><link rel="prefetch" href="/github-blog/assets/js/14.1e637a97.js"><link rel="prefetch" href="/github-blog/assets/js/15.91c4ebc1.js"><link rel="prefetch" href="/github-blog/assets/js/16.f8868b19.js"><link rel="prefetch" href="/github-blog/assets/js/17.92f17462.js"><link rel="prefetch" href="/github-blog/assets/js/18.79071b8a.js"><link rel="prefetch" href="/github-blog/assets/js/19.999d499a.js"><link rel="prefetch" href="/github-blog/assets/js/20.335406b8.js"><link rel="prefetch" href="/github-blog/assets/js/22.b1fff7ad.js"><link rel="prefetch" href="/github-blog/assets/js/23.ccb484b8.js"><link rel="prefetch" href="/github-blog/assets/js/3.55e0a87f.js"><link rel="prefetch" href="/github-blog/assets/js/4.0b322df0.js"><link rel="prefetch" href="/github-blog/assets/js/5.816dad81.js"><link rel="prefetch" href="/github-blog/assets/js/6.abd7a974.js"><link rel="prefetch" href="/github-blog/assets/js/7.cb32d52a.js"><link rel="prefetch" href="/github-blog/assets/js/8.55482e5e.js"><link rel="prefetch" href="/github-blog/assets/js/9.fe6ce754.js">
    <link rel="stylesheet" href="/github-blog/assets/css/0.styles.78aca58c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/github-blog/" class="home-link router-link-active"><!----> <span class="site-name">Blesstosam's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/github-blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/github-blog/blog/" class="nav-link router-link-active">Blog</a></div> <a href="https://github.com/blesstosam/github-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/github-blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/github-blog/blog/" class="nav-link router-link-active">Blog</a></div> <a href="https://github.com/blesstosam/github-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Blog</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/github-blog/blog/" class="sidebar-link">写在前面</a></li><li><a href="/github-blog/blog/async-catch.html" class="sidebar-link">优雅捕获 async 错误</a></li><li><a href="/github-blog/blog/block-chain.html" class="sidebar-link">区块链</a></li><li><a href="/github-blog/blog/business.html" class="sidebar-link">早期创业与技术关系不大</a></li><li><a href="/github-blog/blog/check-list.html" class="sidebar-link">代码审查检查项</a></li><li><a href="/github-blog/blog/code-quality.html" class="sidebar-link">代码质量问题</a></li><li><a href="/github-blog/blog/codelife.html" class="sidebar-link">读codelife有感</a></li><li><a href="/github-blog/blog/front-end-rule.html" class="sidebar-link">前端代码规范</a></li><li><a href="/github-blog/blog/good-experience.html" class="sidebar-link">记录好的用户体验</a></li><li><a href="/github-blog/blog/mac-tips.html" class="sidebar-link">Mac Tips</a></li><li><a href="/github-blog/blog/taobao-ten-years.html" class="sidebar-link">读淘宝十年有感</a></li><li><a href="/github-blog/blog/vue-auth.html" class="sidebar-link">Vue权限系统</a></li><li><a href="/github-blog/blog/vue-i18n.html" class="sidebar-link">Vue-i18n 单独使用</a></li><li><a href="/github-blog/blog/vue-ts.html" class="sidebar-link">Vue+ts 实践</a></li><li><a href="/github-blog/blog/write-backend.html" class="active sidebar-link">写后台总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="写后台总结"><a href="#写后台总结" aria-hidden="true" class="header-anchor">#</a> 写后台总结</h1> <h3 id="多对多关系的表，如果删除某个表的行，另外一个表怎么处理，关系表怎么处理"><a href="#多对多关系的表，如果删除某个表的行，另外一个表怎么处理，关系表怎么处理" aria-hidden="true" class="header-anchor">#</a> 多对多关系的表，如果删除某个表的行，另外一个表怎么处理，关系表怎么处理</h3> <ol><li>比如模板表和模块表，还有一个中间关系表。</li> <li>因为模板引用模块，他们之间的引用关系在中间关系表里有数据表征，如果删除一个模板，中间表不用删除，<strong>因为查找模板所对应模块的时候，首先要到模板表里查找是否有该模板</strong>，而且中间表没有status字段表达是否被删除，它只是一个表达一个关系而已。</li> <li>因为模块被模板引用，当删除模块时，<strong>要先判断是否有被引用</strong>（在中间表里查找即可），如果有被引用，则不能删除。</li> <li><strong>关系表永远只有被动处理</strong></li></ol> <h3 id="为什么后台对数据结构和算法要求很高，我现在是了解了"><a href="#为什么后台对数据结构和算法要求很高，我现在是了解了" aria-hidden="true" class="header-anchor">#</a> 为什么后台对数据结构和算法要求很高，我现在是了解了</h3> <ol><li>当用sql语句从数据库里拿到数据，需要解析成前端所需要的各种格式的数据，这时候各种数组，对象的操作，遍历等，怎么算节省效率，这时候就需要很强的数据操作能力了。</li></ol> <h3 id="关于数据库设计"><a href="#关于数据库设计" aria-hidden="true" class="header-anchor">#</a> 关于数据库设计</h3> <ol><li><a href="https://www.zhihu.com/question/39062169/answer/156096473" target="_blank" rel="noopener noreferrer">使用逻辑外键，而非物理外键<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>设计表，刚开始不用想太多，想到怎样就设计成怎样好了，后面具体到细节的时候再修改。</li> <li>数据库范式</li></ol> <blockquote><ul><li>1NF： 字段是最小的的单元不可再分</li> <li>2NF：满足1NF,表中的字段必须完全依赖于全部主键而非部分主键</li> <li>3NF：满足2NF,非主键外的所有字段必须互不依赖</li> <li>4NF：满足3NF,消除表中的多值依赖</li></ul></blockquote> <ol start="4"><li>查询的时候不要使用select * ，一是影响查询速度，二是如果数据库字段改了，前台的变量名也要跟着改了</li> <li>视图，从表中到出的一个子集，可以限制每个用户可看到的数据库的区域</li> <li>数据库设计过程</li></ol> <ul><li>先设计实体关系图(ERD)</li> <li>设计表结构</li></ul> <ol start="7"><li><strong>应避免过多表的连接查询，连接查询中表越多，查询的执行速度越慢</strong></li> <li>对于有父子关系的表，修改某一条数据，也要修改其下一级的数据，从而形成一个递归修改。<br>
方法1: mysql 只能用函数来实现递归</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delimiter</span> <span class="token comment">// </span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>getParList<span class="token punctuation">`</span><span class="token punctuation">(</span>rootId <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> 
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> sTemp <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> sTempPar <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">SET</span> sTemp <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> 
    <span class="token keyword">SET</span> sTempPar <span class="token operator">=</span>rootId<span class="token punctuation">;</span> 
 
    <span class="token comment">#循环递归</span>
    <span class="token keyword">WHILE</span> sTempPar <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">DO</span> 
        <span class="token comment">#判断是否是第一个，不加的话第一个会为空</span>
        <span class="token keyword">IF</span> sTemp <span class="token operator">!=</span> <span class="token string">''</span> <span class="token keyword">THEN</span>
            <span class="token keyword">SET</span> sTemp <span class="token operator">=</span> concat<span class="token punctuation">(</span>sTemp<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span>sTempPar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">ELSE</span>
            <span class="token keyword">SET</span> sTemp <span class="token operator">=</span> sTempPar<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">SET</span> sTemp <span class="token operator">=</span> concat<span class="token punctuation">(</span>sTemp<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span>sTempPar<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">SELECT</span> group_concat<span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token keyword">INTO</span> sTempPar <span class="token keyword">FROM</span> treenodes <span class="token keyword">where</span> pid<span class="token operator">&lt;&gt;</span>id <span class="token operator">and</span> FIND_IN_SET<span class="token punctuation">(</span>id<span class="token punctuation">,</span>sTempPar<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span> 
 
<span class="token keyword">RETURN</span> sTemp<span class="token punctuation">;</span> 
<span class="token keyword">END</span>
</code></pre></div><p>方法2: <strong>在表中多加一个字段存所有父级的id，每次insert的时候将父级id拼起来存到表里, 后面查找的时候用 like 语句匹配，显然这种方法效率更高</strong>
9. 规范化不是关系型数据库设计最重要的目标。对于第一二三范式，不需要严格遵守。有时候规范化粒度过细所导致的问题不比其所解决的问题少。
10. 现在关系型数据库模型不会扩充到3nf上，有时连3nf也不用，原因在于生成的表太多，所得的sql代码连接很复杂导致数据库响应时间过长，而且磁盘空间并不贵。4nf，5nf，dknf等趋向于在表中加入一些业务逻辑，这一点并无必要。应该由程序来处理业务逻辑，数据库只存数据。
11. <strong>软删除和唯一约束的冲突</strong><br>
软删除把state改为1之后，记录还存在。如果某一个字段是唯一约束的话，比如name，那么新增一个被删除掉一样name的记录，就会报唯一键约束的错误。</p> <h3 id="mysql"><a href="#mysql" aria-hidden="true" class="header-anchor">#</a> Mysql</h3> <ol><li>Mysql 比较灵活，既可以嵌入到应用程序中，也可以支持数据仓库，内容索引和部署软件，高可用的冗余系统，在线事务处理（OLTP）</li> <li>写锁（write lock）会减少并发，但是又是不可避免的。所以要让锁定对象更有选择性，尽量只锁定需要修改的部分数据。锁定的数据越少，系统的并发程度越高。锁策略就是控制锁的粒度。</li> <li>Mysql提供表锁（table lock），行锁（row lock）</li> <li>死锁，指两个或多个事务在同一资源上相互占用，并请求锁定对方占用的资源，并导致恶性循环</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> stock_price <span class="token keyword">set</span> <span class="token keyword">close</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">update</span> stock_price <span class="token keyword">set</span> <span class="token keyword">close</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> stock_price <span class="token keyword">set</span> high <span class="token operator">=</span> <span class="token number">100</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span>
<span class="token keyword">update</span> stock_price <span class="token keyword">set</span> high <span class="token operator">=</span> <span class="token number">120</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre></div><p>如果两个事务都执行了第一条update语句，同时锁定了该行数据，接着每个事务都尝试去执行第二条update语句，却发现该行已经被对方锁定，然后两个事务都等待对方释放锁，同时又持有对方需要的锁，则陷入死循环。<br>
目前InnoDB处理死锁的方式是，<strong>将持有最少行级排他锁的事务进行回滚。</strong></p> <h4 id="数据库优化"><a href="#数据库优化" aria-hidden="true" class="header-anchor">#</a> 数据库优化</h4> <ol><li>避免多表查询返回所有列，如下，查询的列越多，时间越长</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_agent
<span class="token keyword">left</span> <span class="token keyword">join</span> t_admin <span class="token keyword">on</span> t_agent<span class="token punctuation">.</span>agent_id<span class="token operator">=</span>t_admin<span class="token punctuation">.</span>agent_id_fk
<span class="token keyword">left</span> <span class="token keyword">join</span> t_agent_ex <span class="token keyword">on</span> t_agent_agent_id<span class="token operator">=</span>t_admin<span class="token punctuation">.</span>agent_id_fk
</code></pre></div><ol start="2"><li>避免查询重复的数据，比如经常需要查询的数据可以放到缓存里</li> <li>对于查询需要扫描大量数据（比如列表查询），使用索引覆盖扫描，把用于where查询条件的列放到索引里。常用的查询条件列比如 agent_name 可以放到索引里。因为单查 agent_name 的情况比较多。</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_agent <span class="token keyword">where</span> agent_name<span class="token operator">=</span><span class="token string">'sam'</span>
</code></pre></div><ol start="4"><li>是否将一个复杂查询转换成多个简单查询。在传统的实现中，强调在数据库层尽可能完成多的工作，这样做的逻辑是以前认为网络通信的代价很高，但是现在的网络越来越快，这方面的代价很小。当然，分开查询也是有代价的，这个问题需要在实际问题中衡量。</li> <li>删除大量数据时，可以一次删除一部分，比如一万行数据，分多次删除。</li> <li>复杂的多表查询，可以分开查，然后在后台代码里组装数据（当然用多表查询，可以简化代码）。</li></ol> <h3 id="_4gl语言"><a href="#_4gl语言" aria-hidden="true" class="header-anchor">#</a> 4GL语言</h3> <ul><li>1GL 二进制语言</li> <li>2GL 汇编语言 二进制语言的文本缩写</li> <li>3GL 高级编程语言 c js java等</li> <li>4GL sql 两个特征 非过程性的；面向表的</li></ul> <h3 id="业务参数和鉴权参数应该分开，如果鉴权参数在某些接口里也作为业务参数，那么就多传一次参数作为业务参数，鉴权参数还是统一处理。"><a href="#业务参数和鉴权参数应该分开，如果鉴权参数在某些接口里也作为业务参数，那么就多传一次参数作为业务参数，鉴权参数还是统一处理。" aria-hidden="true" class="header-anchor">#</a> 业务参数和鉴权参数应该分开，如果鉴权参数在某些接口里也作为业务参数，那么就多传一次参数作为业务参数，鉴权参数还是统一处理。</h3> <p>一般来说，鉴权参数统一放在header里，或者放在url里。</p> <h3 id="后台比前台更能积累经验，因为后台更容易抽象。"><a href="#后台比前台更能积累经验，因为后台更容易抽象。" aria-hidden="true" class="header-anchor">#</a> 后台比前台更能积累经验，因为后台更容易抽象。</h3> <p>后台的业务逻辑会抽象成数据模型，属于高度抽象，越高的抽象越容易复用，做一次业务，就相当于积累了一次数据模型，下次碰到相同的业务直接复用就行了；相比较前端ui，本来就难抽象，目前最多也就抽象到组件这一层，而且同一套业务可以套不同的ui，等于说你做了这个业务的ui，换了老板说不行，还是要重写一套。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/blesstosam/github-blog/edit/master/docs/blog/write-backend.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">9/13/2019, 8:21:52 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/github-blog/blog/vue-ts.html" class="prev">
          Vue+ts 实践
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/github-blog/assets/js/app.e3b10756.js" defer></script><script src="/github-blog/assets/js/2.1ab0c05b.js" defer></script><script src="/github-blog/assets/js/21.7e3b8cf1.js" defer></script>
  </body>
</html>
